<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro na Nuvem com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 280px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 320px;
            }
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 900;
            line-height: 1;
            color: #1e293b;
        }
        .kpi-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.5rem;
        }
        .action-btn {
            background: linear-gradient(45deg, #4ECDC4, #45B7D1);
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #475569;
            border-bottom-color: #4ECDC4;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loadingOverlay">
        <div class="loader"></div>
        <p class="mt-4 text-slate-600 font-semibold">Conectando e carregando seus dados...</p>
    </div>

    <div id="appContent" class="container mx-auto p-4 md:p-8" style="display: none;">

        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-black text-slate-900">Meu Painel de Controle Financeiro</h1>
            <p class="mt-2 text-lg text-slate-600">Seus dados salvos na nuvem, acess√≠veis de qualquer lugar.</p>
            <div id="userInfo" class="mt-4 text-sm text-slate-500 bg-slate-100 p-2 rounded-md inline-block"></div>
        </header>

        <section id="overview" class="mb-12">
            <h2 class="text-2xl font-bold text-center mb-6 text-slate-700">Vis√£o Geral R√°pida</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="kpi-card">
                    <div id="kpiSalario" class="kpi-value" style="color: #4ECDC4;">R$ 0,00</div>
                    <div class="kpi-label">Sal√°rio L√≠quido Mensal</div>
                </div>
                <div class="kpi-card">
                    <div id="kpiGastos" class="kpi-value" style="color: #f59e0b;">R$ 0,00</div>
                    <div class="kpi-label">Gastos Totais Mensais</div>
                </div>
                <div class="kpi-card">
                    <div id="kpiDividas" class="kpi-value" style="color: #FF6B6B;">R$ 0,00</div>
                    <div class="kpi-label">Total de D√≠vidas Mensais</div>
                </div>
                <div class="kpi-card">
                    <div id="kpiMetas" class="kpi-value" style="color: #45B7D1;">R$ 0,00</div>
                    <div class="kpi-label">Valor Total das Metas</div>
                </div>
            </div>
        </section>

        <section id="edit-data" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold mb-4 text-center">‚úèÔ∏è Editar Meus Dados</h3>
            <form id="financialForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-8">
                <div class="space-y-4">
                    <h4 class="font-bold text-lg text-slate-700 border-b pb-2">Renda e Despesas</h4>
                    <div>
                        <label for="salario" class="block text-sm font-medium text-slate-600">Sal√°rio L√≠quido</label>
                        <input type="number" id="salario" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                     <div>
                        <label for="dizimo" class="block text-sm font-medium text-slate-600">D√≠zimo</label>
                        <input type="number" id="dizimo" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="internet" class="block text-sm font-medium text-slate-600">Internet</label>
                        <input type="number" id="internet" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                     <div>
                        <label for="faculdade" class="block text-sm font-medium text-slate-600">Faculdade</label>
                        <input type="number" id="faculdade" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="academia" class="block text-sm font-medium text-slate-600">Academia</label>
                        <input type="number" id="academia" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="font-bold text-lg text-slate-700 border-b pb-2">Metas e D√≠vidas</h4>
                    <div id="debtList" class="space-y-3"></div>
                    <button type="button" id="addDebtBtn" class="w-full text-sm text-indigo-600 hover:text-indigo-800 font-semibold py-2 border-2 border-dashed border-slate-300 rounded-md hover:bg-slate-50 transition-colors">+ Adicionar D√≠vida/Cart√£o</button>
                    <hr class="my-4">
                    <div>
                        <label for="metaCasa" class="block text-sm font-medium text-slate-600">Meta Total (Casa)</label>
                        <input type="number" id="metaCasa" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                     <div>
                        <label for="atualCasa" class="block text-sm font-medium text-slate-600">Valor Atual (Casa)</label>
                        <input type="number" id="atualCasa" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="metaPc" class="block text-sm font-medium text-slate-600">Meta Total (PC)</label>
                        <input type="number" id="metaPc" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                    <div>
                        <label for="atualPc" class="block text-sm font-medium text-slate-600">Valor Atual (PC)</label>
                        <input type="number" id="atualPc" step="0.01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                </div>
                 <div class="space-y-4">
                     <h4 class="font-bold text-lg text-slate-700 border-b pb-2">Renda Extra (Rifa)</h4>
                     <div>
                        <label for="metaRifa" class="block text-sm font-medium text-slate-600">Meta de N√∫meros</label>
                        <input type="number" id="metaRifa" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                     <div>
                        <label for="vendidosRifa" class="block text-sm font-medium text-slate-600">N√∫meros Vendidos</label>
                        <input type="number" id="vendidosRifa" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                    </div>
                 </div>
            </form>
            <div class="text-center mt-6">
                <button type="button" id="saveChangesBtn" class="action-btn text-white font-bold py-2 px-6 rounded-lg shadow-md">Salvar Altera√ß√µes na Nuvem</button>
                <p id="saveMessage" class="text-green-600 mt-2 h-6"></p>
            </div>
        </section>
        
        <section id="gemini-analysis" class="bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <h3 class="text-xl font-bold mb-2">‚ú® An√°lise e Dicas com IA ‚ú®</h3>
            <p class="text-slate-600 mb-4">Clique no bot√£o abaixo para que o Gemini analise seus dados e gere conselhos personalizados para voc√™ atingir suas metas mais r√°pido!</p>
            <button id="generateAnalysisBtn" class="action-btn text-white font-bold py-2 px-4 rounded-lg shadow-md">
                Gerar An√°lise Financeira
            </button>
            <div id="analysisResult" class="mt-6 text-left p-4 bg-slate-50 rounded-lg min-h-[100px] flex items-center justify-center">
                 <p class="text-slate-500">Sua an√°lise aparecer√° aqui...</p>
            </div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div id="goals" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-center">üéØ Meus Cofres de Sonhos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div>
                        <div class="chart-container">
                            <canvas id="goalHomeChart"></canvas>
                        </div>
                        <p class="text-center mt-2 font-semibold">Casa: Geladeira + Cooktop</p>
                    </div>
                    <div>
                        <div class="chart-container">
                            <canvas id="goalPcChart"></canvas>
                        </div>
                         <p class="text-center mt-2 font-semibold">Lazer: Upgrade do PC</p>
                    </div>
                </div>
            </div>

            <div id="budget" class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-center">üìä Or√ßamento Mensal Simplificado</h3>
                <div class="chart-container h-80 md:h-96">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <div id="debt-freedom" class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-center">üöÄ O Caminho para a Liberdade Financeira</h3>
                <div class="text-center"><p class="text-slate-600 mb-4">Veja o salto no seu potencial de poupan√ßa mensal ap√≥s quitar as d√≠vidas em Nov/2025. A liberdade financeira est√° pr√≥xima!</p></div>
                <div class="chart-container h-64">
                     <canvas id="savingsPowerChart"></canvas>
                </div>
            </div>

            <div id="raffle" class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-center">üéüÔ∏è Opera√ß√£o Casa Nova - Rifa</h3>
                 <div class="flex flex-col md:flex-row items-center gap-8">
                    <div class="w-full md:w-1/2">
                         <p class="text-center text-slate-600 mb-6">Sua iniciativa de renda extra √© a chave para acelerar a meta da casa. Acompanhe o progresso das vendas!</p>
                         <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p id="rifaPotencial" class="text-2xl font-bold" style="color: #FED766;">R$ 0</p>
                                <p class="text-sm text-slate-500">Lucro Potencial</p>
                            </div>
                            <div>
                                <p id="rifaArrecadado" class="text-2xl font-bold" style="color: #4ECDC4;">R$ 0</p>
                                <p class="text-sm text-slate-500">Total Arrecadado</p>
                            </div>
                         </div>
                    </div>
                    <div class="w-full md:w-1/2">
                         <div class="chart-container">
                            <canvas id="raffleChart"></canvas>
                        </div>
                        <p class="text-center mt-2 font-semibold">Progresso da Venda de N√∫meros</p>
                    </div>
                 </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 py-4 border-t">
            <p class="text-slate-500">Infogr√°fico financeiro gerado para um futuro pr√≥spero.</p>
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Suas Chaves Pessoais do Firebase ---
        // Este bloco conecta o site ao seu projeto "financeiro-7c28e"
        const firebaseConfig = {
          apiKey: "AIzaSyDmgBe4wqDaamTRRlolUSBCR1Hp9wYScoU",
          authDomain: "financeiro-7c28e.firebaseapp.com",
          projectId: "financeiro-7c28e",
          storageBucket: "financeiro-7c28e.appspot.com",
          messagingSenderId: "29137515180",
          appId: "1:29137515180:web:80ea12781a59b001bfe509"
        };

        // --- Inicializa√ß√£o do Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Elementos da UI ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const appContent = document.getElementById('appContent');
        const userInfoDiv = document.getElementById('userInfo');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const saveMessage = document.getElementById('saveMessage');
        const debtListContainer = document.getElementById('debtList');
        const addDebtBtn = document.getElementById('addDebtBtn');
        const generateAnalysisBtn = document.getElementById('generateAnalysisBtn');
        const analysisResultDiv = document.getElementById('analysisResult');

        // --- Vari√°veis Globais da Aplica√ß√£o ---
        let financialData = {};
        let charts = {};
        let currentUser = null;
        let financialDataRef = null;
        let unsubscribe = null; // Fun√ß√£o para desligar o listener do onSnapshot

        const formElements = {
            salario: document.getElementById('salario'), dizimo: document.getElementById('dizimo'),
            internet: document.getElementById('internet'), faculdade: document.getElementById('faculdade'),
            academia: document.getElementById('academia'), metaCasa: document.getElementById('metaCasa'),
            atualCasa: document.getElementById('atualCasa'), metaPc: document.getElementById('metaPc'),
            atualPc: document.getElementById('atualPc'), metaRifa: document.getElementById('metaRifa'),
            vendidosRifa: document.getElementById('vendidosRifa')
        };
        
        const kpiElements = {
            salario: document.getElementById('kpiSalario'), gastos: document.getElementById('kpiGastos'),
            dividas: document.getElementById('kpiDividas'), metas: document.getElementById('kpiMetas'),
            rifaPotencial: document.getElementById('rifaPotencial'), rifaArrecadado: document.getElementById('rifaArrecadado')
        };

        // --- Fun√ß√µes Principais ---
        
        async function main() {
            initializeCharts();
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const appId = 'financial-planner-app'; // Um ID fixo para o app
                    userInfoDiv.innerHTML = `<strong>Seu ID de Usu√°rio:</strong> ${user.uid}`;
                    financialDataRef = doc(db, `artifacts/${appId}/users/${user.uid}/financialData`, 'data');
                    
                    if (unsubscribe) unsubscribe(); // Desliga listener anterior se houver
                    
                    unsubscribe = onSnapshot(financialDataRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            populateForm(data);
                            processAndDisplayData(data);
                        } else {
                            console.log("Documento n√£o encontrado! Criando com dados iniciais.");
                            createInitialDocument();
                        }
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => { loadingOverlay.style.display = 'none'; appContent.style.display = 'block'; }, 300);
                    }, (error) => {
                        console.error("Erro ao ouvir dados:", error);
                        alert("N√£o foi poss√≠vel carregar seus dados. Por favor, recarregue a p√°gina.");
                    });

                } else {
                    console.log("Nenhum usu√°rio logado. Realizando login an√¥nimo.");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Erro no login:", error);
                        loadingOverlay.innerHTML = '<p class="text-red-500">Erro de autentica√ß√£o. N√£o foi poss√≠vel carregar a aplica√ß√£o.</p>';
                    }
                }
            });
        }

        async function createInitialDocument() {
            const initialData = {
                salario: 1503.34, dizimo: 150.33, internet: 156.34, faculdade: 181.75, academia: 89.90,
                metaCasa: 3600, atualCasa: 500, metaPc: 2400, atualPc: 240,
                metaRifa: 400, vendidosRifa: 50,
                debts: [
                    { name: 'Parcelamento Will Bank', value: 227.99 },
                    { name: 'Empr√©stimo Nubank', value: 418.17 }
                ]
            };
            try {
                await setDoc(financialDataRef, initialData);
                console.log("Documento inicial criado com sucesso!");
            } catch (error) {
                console.error("Erro ao criar documento inicial:", error);
            }
        }
        
        function populateForm(data) {
            for (const key in formElements) {
                if (data.hasOwnProperty(key)) {
                    formElements[key].value = data[key];
                }
            }
            debtListContainer.innerHTML = '';
            if (data.debts && Array.isArray(data.debts)) {
                data.debts.forEach(debt => addDebtEntry(debt.name, debt.value));
            }
        }

        function processAndDisplayData(data) {
            financialData = data;
            financialData.totalFixas = (data.dizimo || 0) + (data.internet || 0) + (data.faculdade || 0) + (data.academia || 0);
            financialData.totalDividas = data.debts ? data.debts.reduce((acc, debt) => acc + (debt.value || 0), 0) : 0;
            financialData.totalGastos = financialData.totalFixas + financialData.totalDividas;
            financialData.sobra = (data.salario || 0) - financialData.totalGastos;
            financialData.poupancaFutura = (data.salario || 0) - financialData.totalFixas;
            financialData.totalMetas = (data.metaCasa || 0) + (data.metaPc || 0);
            financialData.rifaValorNumero = 10;
            financialData.rifaPotencial = (data.metaRifa || 0) * financialData.rifaValorNumero * 0.875;
            financialData.rifaArrecadado = (data.vendidosRifa || 0) * financialData.rifaValorNumero;
            updateUI();
        }

        function updateUI() {
            kpiElements.salario.textContent = formatCurrency(financialData.salario || 0);
            kpiElements.gastos.textContent = formatCurrency(financialData.totalGastos || 0);
            kpiElements.dividas.textContent = formatCurrency(financialData.totalDividas || 0);
            kpiElements.metas.textContent = formatCurrency(financialData.totalMetas || 0);
            kpiElements.rifaPotencial.textContent = formatCurrency(financialData.rifaPotencial || 0);
            kpiElements.rifaArrecadado.textContent = formatCurrency(financialData.rifaArrecadado || 0);

            updateChart(charts.goalHome, [financialData.atualCasa || 0, Math.max(0, (financialData.metaCasa || 0) - (financialData.atualCasa || 0))]);
            updateChart(charts.goalPc, [financialData.atualPc || 0, Math.max(0, (financialData.metaPc || 0) - (financialData.atualPc || 0))]);
            updateChart(charts.budget, [financialData.totalFixas || 0, financialData.totalDividas || 0, Math.max(0, financialData.sobra || 0)]);
            charts.budget.data.labels = [`Despesas Fixas (${formatCurrency(financialData.totalFixas || 0)})`, `D√≠vidas (${formatCurrency(financialData.totalDividas || 0)})`, `Sobra/Poupan√ßa (${formatCurrency(financialData.sobra || 0)})`];
            updateChart(charts.savingsPower, [financialData.sobra || 0, financialData.poupancaFutura || 0], 0);
            updateChart(charts.raffle, [financialData.vendidosRifa || 0, Math.max(0, (financialData.metaRifa || 0) - (financialData.vendidosRifa || 0))]);
            
            charts.budget.update();
            charts.savingsPower.update();
        }
        
        async function handleSaveChanges() {
            saveChangesBtn.disabled = true;
            const dataToSave = {};
            for (const key in formElements) {
                dataToSave[key] = parseFloat(formElements[key].value) || 0;
            }
            dataToSave.debts = [];
            document.querySelectorAll('.debt-entry').forEach(entry => {
                const name = entry.querySelector('.debt-name').value || 'D√≠vida';
                const value = parseFloat(entry.querySelector('.debt-value').value) || 0;
                if (value > 0) dataToSave.debts.push({ name, value });
            });

            try {
                await setDoc(financialDataRef, dataToSave);
                saveMessage.textContent = 'Dados salvos na nuvem!';
                setTimeout(() => { saveMessage.textContent = ''; }, 3000);
            } catch (error) {
                console.error("Erro ao salvar dados:", error);
                saveMessage.textContent = 'Erro ao salvar!';
                saveMessage.classList.replace('text-green-600', 'text-red-600');
            } finally {
                saveChangesBtn.disabled = false;
            }
        }

        // --- Fun√ß√µes Auxiliares e de UI ---
        function formatCurrency(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function updateChart(chart, data, datasetIndex = 0) { if (chart) { chart.data.datasets[datasetIndex].data = data; chart.update(); } }
        function addDebtEntry(name = '', value = '') {
            const debtId = Date.now() + Math.random();
            const entryDiv = document.createElement('div');
            entryDiv.className = 'debt-entry flex items-center gap-2 p-2 bg-slate-50 rounded-md';
            entryDiv.innerHTML = `
                <div class="flex-grow"><input type="text" value="${name}" placeholder="Nome da D√≠vida" class="debt-name w-full text-sm p-1 rounded-md border-slate-300"></div>
                <div class="flex-grow"><input type="number" value="${value}" placeholder="Valor" step="0.01" class="debt-value w-full text-sm p-1 rounded-md border-slate-300"></div>
                <button type="button" class="remove-debt-btn text-red-500 hover:text-red-700 font-bold p-1 rounded-full">&times;</button>
            `;
            debtListContainer.appendChild(entryDiv);
            entryDiv.querySelector('.remove-debt-btn').addEventListener('click', () => entryDiv.remove());
        }

        // --- Inicializa√ß√£o de Gr√°ficos ---
        function initializeCharts() {
            const tooltipTitleCallback = (tooltipItems) => {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) { return label.join(' '); }
                return label;
            };
            const sharedDoughnutOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { size: 12 } } }, tooltip: { callbacks: { title: tooltipTitleCallback } } } };
            const colors = { coral: '#FF6B6B', turquoise: '#4ECDC4', blue: '#45B7D1', yellow: '#FED766', lightGray: '#E9E9E9' };

            charts.goalHome = new Chart(document.getElementById('goalHomeChart'), { type: 'doughnut', data: { labels: [['Fundo para a Casa', '(Geladeira + Cooktop)'], 'Faltante'], datasets: [{ data: [0, 1], backgroundColor: [colors.turquoise, colors.lightGray], borderWidth: 4 }] }, options: sharedDoughnutOptions });
            charts.goalPc = new Chart(document.getElementById('goalPcChart'), { type: 'doughnut', data: { labels: [['Upgrade Completo', 'do PC'], 'Faltante'], datasets: [{ data: [0, 1], backgroundColor: [colors.blue, colors.lightGray], borderWidth: 4 }] }, options: sharedDoughnutOptions });
            charts.budget = new Chart(document.getElementById('budgetChart'), { type: 'doughnut', data: { labels: ['Despesas Fixas', 'D√≠vidas', 'Sobra/Poupan√ßa'], datasets: [{ data: [1, 1, 1], backgroundColor: [colors.coral, colors.yellow, colors.turquoise], borderWidth: 4 }] }, options: sharedDoughnutOptions });
            charts.savingsPower = new Chart(document.getElementById('savingsPowerChart'), { type: 'bar', data: { labels: ['Potencial de Poupan√ßa Atual', 'Potencial Futuro (Dez/25)'], datasets: [{ label: 'Poder de Poupan√ßa Mensal (R$)', data: [0, 0], backgroundColor: [colors.yellow, colors.turquoise], borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, tooltip: { callbacks: { title: tooltipTitleCallback } } } } });
            charts.raffle = new Chart(document.getElementById('raffleChart'), { type: 'doughnut', data: { labels: ['N√∫meros Vendidos', 'N√∫meros Restantes'], datasets: [{ data: [0, 1], backgroundColor: [colors.coral, colors.lightGray], borderWidth: 4 }] }, options: {...sharedDoughnutOptions, plugins: {...sharedDoughnutOptions.plugins, legend: {display: false}}} });
        }
        
        // --- L√≥gica da IA Gemini ---
        generateAnalysisBtn.addEventListener('click', async () => {
            generateAnalysisBtn.disabled = true;
            analysisResultDiv.innerHTML = '<div class="loader"></div>';

            let debtsPrompt = financialData.debts && financialData.debts.length > 0
                ? financialData.debts.map(d => `- Parcela ${d.name}: ${formatCurrency(d.value)}`).join('\n')
                : "- Nenhuma d√≠vida registrada.";

            const prompt = `
                Aja como um consultor financeiro amig√°vel e motivador. Com base nos seguintes dados de um usu√°rio no Brasil, forne√ßa uma an√°lise curta e objetiva em formato de lista com 3 a 4 dicas pr√°ticas e personalizadas para melhorar a sa√∫de financeira e atingir as metas mais r√°pido.
                
                Dados Financeiros:
                - Sal√°rio L√≠quido Mensal: ${formatCurrency(financialData.salario)}
                - Total de Gastos Mensais: ${formatCurrency(financialData.totalGastos)}
                - Sobra Mensal / Potencial de Poupan√ßa Atual: ${formatCurrency(financialData.sobra)}
                
                D√≠vidas Atuais:
                ${debtsPrompt}

                Metas:
                - Meta 1 (Casa): Valor total ${formatCurrency(financialData.metaCasa)}, j√° possui ${formatCurrency(financialData.atualCasa)}.
                - Meta 2 (PC): Valor total ${formatCurrency(financialData.metaPc)}, j√° possui ${formatCurrency(financialData.atualPc)}.
                
                Renda Extra (Rifa):
                - Potencial de Lucro: ${formatCurrency(financialData.rifaPotencial)}
                - Progresso: ${financialData.vendidosRifa} de ${financialData.metaRifa} n√∫meros vendidos.

                Use uma linguagem positiva e encorajadora. Comece com uma sauda√ß√£o e termine com uma frase de motiva√ß√£o. Formate as dicas como uma lista com marcadores (bullet points), usando <strong>‚Ä¢</strong> para cada ponto. Use <br><br> para separar os pontos da lista.
            `;
            
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] }) });
                if (!response.ok) { throw new Error(`API error: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                    let text = result.candidates[0].content.parts[0].text;
                    analysisResultDiv.innerHTML = `<div class="prose prose-sm max-w-none">${text}</div>`;
                } else { throw new Error("Resposta da IA inv√°lida ou vazia."); }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                analysisResultDiv.innerHTML = `<p class="text-red-500">Desculpe, n√£o foi poss√≠vel gerar a an√°lise. Tente novamente mais tarde.</p>`;
            } finally {
                generateAnalysisBtn.disabled = false;
            }
        });

        // --- Event Listeners ---
        addDebtBtn.addEventListener('click', () => addDebtEntry());
        saveChangesBtn.addEventListener('click', handleSaveChanges);

        // --- Ponto de Entrada da Aplica√ß√£o ---
        main();
    </script>
</body>
</html>
